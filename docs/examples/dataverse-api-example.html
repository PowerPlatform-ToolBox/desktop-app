<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dataverse API Examples</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #0078d4;
            border-bottom: 3px solid #0078d4;
            padding-bottom: 10px;
        }
        h2 {
            color: #106ebe;
            margin-top: 30px;
        }
        .example-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #106ebe;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            border-left: 4px solid #0078d4;
        }
        code {
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
        }
        .output {
            background: #e8f4f8;
            padding: 15px;
            margin-top: 10px;
            border-radius: 4px;
            min-height: 50px;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            background: #fde7e9;
            color: #a80000;
        }
        .success {
            background: #dff6dd;
            color: #107c10;
        }
        .info {
            background: #fff4ce;
            color: #8a6d3b;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            box-sizing: border-box;
        }
        textarea {
            font-family: 'Courier New', Courier, monospace;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>üöÄ Dataverse API Examples</h1>
    
    <div class="info">
        <strong>Note:</strong> These examples demonstrate how to use the Dataverse API in your Power Platform Tool Box tools.
        Make sure you have an active connection to a Dataverse environment before running these examples.
    </div>

    <!-- CRUD Operations -->
    <div class="example-section">
        <h2>üìù CRUD Operations</h2>
        
        <h3>Create a Record</h3>
        <div class="input-group">
            <label>Account Name:</label>
            <input type="text" id="accountName" placeholder="Contoso Ltd" value="Test Account">
        </div>
        <button onclick="createAccount()">Create Account</button>
        <div id="createOutput" class="output"></div>
        
        <h3>Retrieve a Record</h3>
        <div class="input-group">
            <label>Account ID:</label>
            <input type="text" id="accountId" placeholder="Enter GUID from create operation">
        </div>
        <div class="input-group">
            <label>Select Columns (comma-separated, leave empty for all):</label>
            <input type="text" id="selectColumns" placeholder="name,emailaddress1,telephone1">
        </div>
        <button onclick="retrieveAccount()">Retrieve Account</button>
        <div id="retrieveOutput" class="output"></div>
        
        <h3>Update a Record</h3>
        <div class="input-group">
            <label>Account ID to Update:</label>
            <input type="text" id="updateAccountId" placeholder="Enter GUID">
        </div>
        <div class="input-group">
            <label>New Account Name:</label>
            <input type="text" id="updateAccountName" placeholder="Updated Account Name">
        </div>
        <button onclick="updateAccount()">Update Account</button>
        <div id="updateOutput" class="output"></div>
        
        <h3>Delete a Record</h3>
        <div class="input-group">
            <label>Account ID to Delete:</label>
            <input type="text" id="deleteAccountId" placeholder="Enter GUID">
        </div>
        <button onclick="deleteAccount()">Delete Account</button>
        <div id="deleteOutput" class="output"></div>
    </div>

    <!-- FetchXML Queries -->
    <div class="example-section">
        <h2>üîç FetchXML Queries</h2>
        
        <h3>Query Accounts with FetchXML</h3>
        <div class="input-group">
            <label>FetchXML Query:</label>
            <textarea id="fetchXml">
<fetch top="10">
  <entity name="account">
    <attribute name="name" />
    <attribute name="accountid" />
    <attribute name="emailaddress1" />
    <attribute name="telephone1" />
    <order attribute="name" />
  </entity>
</fetch>
            </textarea>
        </div>
        <button onclick="executeFetchXml()">Execute FetchXML</button>
        <div id="fetchXmlOutput" class="output"></div>

        <h3>Query with Filter</h3>
        <button onclick="queryAccountsWithFilter()">Query Accounts (Name starts with 'A')</button>
        <div id="filterQueryOutput" class="output"></div>
    </div>

    <!-- Metadata Operations -->
    <div class="example-section">
        <h2>üìä Metadata Operations</h2>
        
        <h3>Get Entity Metadata</h3>
        <div class="input-group">
            <label>Entity Logical Name:</label>
            <input type="text" id="entityName" placeholder="account" value="account">
        </div>
        <button onclick="getEntityMetadata()">Get Entity Metadata</button>
        <div id="metadataOutput" class="output"></div>
        
        <h3>Get All Entities</h3>
        <button onclick="getAllEntitiesMetadata()">Get All Entities Metadata</button>
        <div id="allEntitiesOutput" class="output"></div>
    </div>

    <!-- Advanced Operations -->
    <div class="example-section">
        <h2>‚ö° Advanced Operations</h2>
        
        <h3>Execute WhoAmI Action</h3>
        <button onclick="executeWhoAmI()">Execute WhoAmI</button>
        <div id="whoAmIOutput" class="output"></div>
        
        <h3>Execute Custom Action</h3>
        <div class="input-group">
            <label>Action Name:</label>
            <input type="text" id="actionName" placeholder="new_CustomAction">
        </div>
        <button onclick="executeCustomAction()">Execute Custom Action</button>
        <div id="customActionOutput" class="output"></div>
    </div>

    <!-- Code Examples -->
    <div class="example-section">
        <h2>üíª Code Examples</h2>
        
        <h3>Basic CRUD Example</h3>
        <pre><code>// Create a new contact
const newContact = await dataverseAPI.create('contact', {
    firstname: 'John',
    lastname: 'Doe',
    emailaddress1: 'john.doe@example.com'
});
console.log('Created contact:', newContact.id);

// Retrieve the contact
const contact = await dataverseAPI.retrieve(
    'contact', 
    newContact.id, 
    ['firstname', 'lastname', 'emailaddress1']
);

// Update the contact
await dataverseAPI.update('contact', newContact.id, {
    jobtitle: 'Software Engineer'
});

// Delete the contact
await dataverseAPI.delete('contact', newContact.id);</code></pre>

        <h3>FetchXML Query Example</h3>
        <pre><code>// Query active contacts
const fetchXml = `
<fetch top="50">
  <entity name="contact">
    <attribute name="fullname" />
    <attribute name="emailaddress1" />
    <filter>
      <condition attribute="statecode" operator="eq" value="0" />
    </filter>
    <order attribute="fullname" />
  </entity>
</fetch>
`;

const result = await dataverseAPI.fetchXmlQuery(fetchXml);
console.log(`Found ${result.value.length} contacts`);
result.value.forEach(contact => {
    console.log(`${contact.fullname} - ${contact.emailaddress1}`);
});</code></pre>

        <h3>Metadata Query Example</h3>
        <pre><code>// Get metadata for account entity
const metadata = await dataverseAPI.getEntityMetadata('account');
console.log('Entity Display Name:', 
    metadata.DisplayName?.LocalizedLabels[0]?.Label);

// Get all entities
const allEntities = await dataverseAPI.getAllEntitiesMetadata();
console.log(`Total entities: ${allEntities.value.length}`);</code></pre>

        <h3>Execute Action Example</h3>
        <pre><code>// Execute WhoAmI function
const whoAmI = await dataverseAPI.execute({
    operationName: 'WhoAmI',
    operationType: 'function'
});
console.log('User ID:', whoAmI.UserId);

// Execute bound action on account
const result = await dataverseAPI.execute({
    entityName: 'account',
    entityId: accountId,
    operationName: 'CalculateRollupField',
    operationType: 'action',
    parameters: {
        FieldName: 'field_name'
    }
});</code></pre>
    </div>

    <script>
        // Helper function to display output
        function displayOutput(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = isError ? 'output error' : 'output success';
            element.textContent = typeof data === 'object' 
                ? JSON.stringify(data, null, 2) 
                : data;
        }

        // Create Account
        async function createAccount() {
            try {
                const name = document.getElementById('accountName').value;
                const result = await dataverseAPI.create('account', {
                    name: name,
                    emailaddress1: 'info@example.com',
                    telephone1: '555-0100'
                });
                displayOutput('createOutput', {
                    message: 'Account created successfully!',
                    id: result.id,
                    details: result
                });
                // Auto-fill the ID fields
                document.getElementById('accountId').value = result.id;
                document.getElementById('updateAccountId').value = result.id;
            } catch (error) {
                displayOutput('createOutput', `Error: ${error.message}`, true);
            }
        }

        // Retrieve Account
        async function retrieveAccount() {
            try {
                const id = document.getElementById('accountId').value;
                const columnsStr = document.getElementById('selectColumns').value;
                const columns = columnsStr ? columnsStr.split(',').map(c => c.trim()) : undefined;
                
                const result = await dataverseAPI.retrieve('account', id, columns);
                displayOutput('retrieveOutput', result);
            } catch (error) {
                displayOutput('retrieveOutput', `Error: ${error.message}`, true);
            }
        }

        // Update Account
        async function updateAccount() {
            try {
                const id = document.getElementById('updateAccountId').value;
                const name = document.getElementById('updateAccountName').value;
                
                await dataverseAPI.update('account', id, {
                    name: name,
                    description: 'Updated via Dataverse API'
                });
                displayOutput('updateOutput', 'Account updated successfully!');
            } catch (error) {
                displayOutput('updateOutput', `Error: ${error.message}`, true);
            }
        }

        // Delete Account
        async function deleteAccount() {
            try {
                const id = document.getElementById('deleteAccountId').value;
                await dataverseAPI.delete('account', id);
                displayOutput('deleteOutput', 'Account deleted successfully!');
            } catch (error) {
                displayOutput('deleteOutput', `Error: ${error.message}`, true);
            }
        }

        // Execute FetchXML
        async function executeFetchXml() {
            try {
                const fetchXml = document.getElementById('fetchXml').value.trim();
                const result = await dataverseAPI.fetchXmlQuery(fetchXml);
                displayOutput('fetchXmlOutput', {
                    count: result.value.length,
                    records: result.value
                });
            } catch (error) {
                displayOutput('fetchXmlOutput', `Error: ${error.message}`, true);
            }
        }

        // Query with Filter
        async function queryAccountsWithFilter() {
            try {
                const fetchXml = `
<fetch top="10">
  <entity name="account">
    <attribute name="name" />
    <attribute name="accountid" />
    <filter>
      <condition attribute="name" operator="like" value="A%" />
    </filter>
  </entity>
</fetch>`;
                const result = await dataverseAPI.fetchXmlQuery(fetchXml);
                displayOutput('filterQueryOutput', {
                    count: result.value.length,
                    records: result.value
                });
            } catch (error) {
                displayOutput('filterQueryOutput', `Error: ${error.message}`, true);
            }
        }

        // Get Entity Metadata
        async function getEntityMetadata() {
            try {
                const entityName = document.getElementById('entityName').value;
                const result = await dataverseAPI.getEntityMetadata(entityName);
                displayOutput('metadataOutput', {
                    LogicalName: result.LogicalName,
                    MetadataId: result.MetadataId,
                    DisplayName: result.DisplayName?.LocalizedLabels?.[0]?.Label,
                    AttributeCount: result.Attributes?.length || 0
                });
            } catch (error) {
                displayOutput('metadataOutput', `Error: ${error.message}`, true);
            }
        }

        // Get All Entities Metadata
        async function getAllEntitiesMetadata() {
            try {
                const result = await dataverseAPI.getAllEntitiesMetadata();
                displayOutput('allEntitiesOutput', {
                    totalEntities: result.value.length,
                    sampleEntities: result.value.slice(0, 10).map(e => ({
                        LogicalName: e.LogicalName,
                        DisplayName: e.DisplayName?.LocalizedLabels?.[0]?.Label
                    }))
                });
            } catch (error) {
                displayOutput('allEntitiesOutput', `Error: ${error.message}`, true);
            }
        }

        // Execute WhoAmI
        async function executeWhoAmI() {
            try {
                const result = await dataverseAPI.execute({
                    operationName: 'WhoAmI',
                    operationType: 'function'
                });
                displayOutput('whoAmIOutput', result);
            } catch (error) {
                displayOutput('whoAmIOutput', `Error: ${error.message}`, true);
            }
        }

        // Execute Custom Action
        async function executeCustomAction() {
            try {
                const actionName = document.getElementById('actionName').value;
                const result = await dataverseAPI.execute({
                    operationName: actionName,
                    operationType: 'action',
                    parameters: {}
                });
                displayOutput('customActionOutput', result);
            } catch (error) {
                displayOutput('customActionOutput', `Error: ${error.message}`, true);
            }
        }

        // Check if dataverseAPI is available
        if (typeof dataverseAPI === 'undefined') {
            document.body.innerHTML = `
                <div style="padding: 40px; text-align: center;">
                    <h1 style="color: #a80000;">‚ùå Dataverse API Not Available</h1>
                    <p>This page must be loaded as a tool within Power Platform Tool Box.</p>
                    <p>The <code>dataverseAPI</code> object is injected by the toolboxAPIBridge.</p>
                </div>
            `;
        }
    </script>
</body>
</html>
