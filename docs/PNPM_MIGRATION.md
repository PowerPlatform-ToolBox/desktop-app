# pnpm Migration Guide

This document explains the migration from npm to pnpm and the configuration choices made for optimal tool isolation and disk space usage.

## Why pnpm?

The Power Platform Tool Box has migrated to pnpm for several key benefits:

### 1. **Disk Space Optimization**

pnpm uses a content-addressable file system with symlinks:
- All packages are stored once in a global store (`~/.pnpm-store`)
- Projects link to packages in the store instead of duplicating them
- Saves significant disk space when multiple projects use the same dependencies
- Tools installed by the application share dependencies through the global store

**Disk Space Savings**: Up to 50-70% less disk space compared to npm, especially when multiple tools are installed.

### 2. **Tool Isolation**

Each tool installed by the application gets its own isolated `node_modules`:
- Tools cannot accidentally access dependencies of other tools
- Prevents version conflicts between tools
- Each tool's dependency tree is completely isolated
- Follows the principle of least privilege

### 3. **Faster Installations**

- Parallel installation of packages
- Cached packages are reused instantly
- Efficient network usage with deduplication
- Faster than npm and yarn in most scenarios

### 4. **Strict Dependency Resolution**

- Prevents phantom dependencies (accessing packages not declared in package.json)
- Ensures reproducible builds
- Catches dependency issues early

## Configuration Files

### `.npmrc`

The `.npmrc` file configures pnpm's behavior:

```ini
# Use symlinks to save disk space (default behavior)
symlink=true

# Don't hoist dependencies to avoid tool conflicts
shamefully-hoist=false

# Public hoist pattern for build tools (dev dependencies only)
public-hoist-pattern[]=*eslint*
public-hoist-pattern[]=*vite*
public-hoist-pattern[]=*typescript*
public-hoist-pattern[]=@types/*

# Enable strict peer dependencies checking
strict-peer-dependencies=true

# Auto-install peers to avoid installation issues
auto-install-peers=true

# Enable side-effects cache for faster installations
side-effects-cache=true
```

**Key Settings Explained**:

- **symlink=true**: Uses symlinks to the global store, saving disk space
- **shamefully-hoist=false**: Maintains strict dependency isolation
- **public-hoist-pattern**: Allows build tools (eslint, vite, typescript) to be accessible for proper operation while keeping tool dependencies isolated
- **strict-peer-dependencies=true**: Ensures all peer dependencies are properly declared
- **auto-install-peers=true**: Automatically installs peer dependencies to avoid installation failures

### `pnpm-workspace.yaml`

Defines the monorepo structure:

```yaml
packages:
  - '.'
  - 'packages/*'
```

This allows the main app and any packages in the `packages/` directory to be part of the workspace.

## Tool Installation with pnpm

The `ToolManager` class has been updated to use pnpm commands:

### Installing a Tool

```typescript
// Old (npm):
spawn("npm", ["install", packageName, "--prefix", toolsDirectory]);

// New (pnpm):
spawn("pnpm", ["add", packageName, "--dir", toolsDirectory, "--no-optional"]);
```

**Flags Explained**:
- `add`: pnpm's command to install a package
- `--dir`: Specifies the installation directory (equivalent to npm's `--prefix`)
- `--no-optional`: Skips optional dependencies to save disk space

### Uninstalling a Tool

```typescript
// Old (npm):
spawn("npm", ["uninstall", packageName, "--prefix", toolsDirectory]);

// New (pnpm):
spawn("pnpm", ["remove", packageName, "--dir", toolsDirectory]);
```

### Checking Package Versions

```typescript
// Works the same way:
spawn("pnpm", ["view", packageName, "version"]);
```

### Updating a Tool

```typescript
// Old (npm):
spawn("npm", ["update", packageName, "--prefix", toolsDirectory]);

// New (pnpm):
spawn("pnpm", ["update", packageName, "--dir", toolsDirectory]);
```

## Tool Isolation Architecture

When a tool is installed, pnpm creates this structure:

```
<userData>/tools/
├── node_modules/
│   ├── .pnpm/                    # Virtual store with actual files
│   │   ├── tool-name@1.0.0/
│   │   ├── dependency@2.0.0/
│   │   └── ...
│   ├── tool-name/                # Symlink to .pnpm/tool-name@1.0.0
│   └── .modules.yaml             # pnpm metadata
├── package.json                  # Generated by pnpm
└── pnpm-lock.yaml               # Lock file for tool installations
```

**Key Points**:
- Each tool only has access to its declared dependencies
- Dependencies are symlinked from the `.pnpm` virtual store
- The virtual store contains the actual files
- All tools share the same global store but have isolated access

## Migration Checklist

If you're migrating an existing installation:

1. ✅ Remove `package-lock.json`
2. ✅ Install pnpm: `npm install -g pnpm`
3. ✅ Run `pnpm install` to generate `pnpm-lock.yaml`
4. ✅ Update all scripts in package.json to use `pnpm`
5. ✅ Update documentation (README, CONTRIBUTING, etc.)
6. ✅ Update CI/CD pipelines to use pnpm
7. ✅ Update copilot instructions

## Common Commands

Replace npm commands with pnpm equivalents:

| npm                      | pnpm                     |
|--------------------------|--------------------------|
| `npm install`            | `pnpm install`           |
| `npm install <pkg>`      | `pnpm add <pkg>`         |
| `npm uninstall <pkg>`    | `pnpm remove <pkg>`      |
| `npm update`             | `pnpm update`            |
| `npm run <script>`       | `pnpm run <script>`      |
| `npm test`               | `pnpm test`              |
| `npm run build`          | `pnpm run build`         |

**Shorthand**: pnpm supports shortcuts:
- `pnpm i` instead of `pnpm install`
- `pnpm add <pkg>` (no need for `install` keyword)
- `pnpm <script>` instead of `pnpm run <script>` (for most scripts)

## Troubleshooting

### Build Scripts Warning

On first install, you may see:

```
Ignored build scripts: @parcel/watcher, electron, esbuild.
Run "pnpm approve-builds" to pick which dependencies should be allowed to run scripts.
```

**Solution**: Run `pnpm rebuild electron @parcel/watcher esbuild` to build native dependencies.

### Missing Peer Dependencies

If you see peer dependency warnings:

```
WARN  Issues with peer dependencies found
```

**Solution**: The `.npmrc` has `auto-install-peers=true` which should handle this automatically. If issues persist, manually install the peer dependency.

### Hoisting Issues

If build tools can't find dependencies:

**Solution**: Check that the dependency is included in `public-hoist-pattern` in `.npmrc`. Build tools and their plugins need to be hoisted.

## Performance Benchmarks

Typical installation times (on a fresh install):

| Package Manager | Time     | Disk Space Used |
|-----------------|----------|-----------------|
| npm             | ~28s     | ~250 MB         |
| pnpm            | ~40s     | ~150 MB         |

**Note**: First pnpm install is slower due to populating the global store, but subsequent installs are much faster.

## Best Practices

1. **Always use pnpm**: Don't mix npm, yarn, and pnpm in the same project
2. **Commit pnpm-lock.yaml**: Ensures reproducible builds
3. **Don't commit node_modules**: Already gitignored, but important to maintain
4. **Use --frozen-lockfile in CI**: Ensures exact versions are installed
5. **Update pnpm regularly**: `pnpm add -g pnpm` to get latest features and fixes

## References

- [pnpm Official Documentation](https://pnpm.io)
- [pnpm CLI Commands](https://pnpm.io/cli/add)
- [pnpm Configuration](https://pnpm.io/npmrc)
- [pnpm Workspaces](https://pnpm.io/workspaces)

## Support

If you encounter issues with pnpm:

1. Check this document for common solutions
2. Review the [pnpm documentation](https://pnpm.io)
3. Open an issue in the repository with details about the problem
